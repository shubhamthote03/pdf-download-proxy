<!DOCTYPE html>
<html>
<head>
  <title>PDF Download Proxy</title>
</head>
<body>
  <h2>Click to download PDF</h2>
  <button onclick="downloadPDF()">Download PDF</button>

  <script>
    async function downloadPDF() {
      const cust_name = "John Doe"; // <-- Replace with dynamic value from Power BI if needed

      try {
        // First: call Azure Function to get base64 string from Databricks
        const response = await fetch("https://powerbicrm-prd.azurewebsites.net/api/DisplayPDFPost?", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ cust_name })
        });

        if (!response.ok) {
          const errorText = await response.text();
          console.error("Server error:", errorText);
          alert(`Error: ${errorText}`);
          return;
        }

        const base64 = await response.text(); // get raw base64 string
        const base64Data = "data:application/pdf;base64," + base64;

        // Decode and download as PDF
        const byteCharacters = atob(base64);
        const byteNumbers = new Array(byteCharacters.length).fill().map((_, i) => byteCharacters.charCodeAt(i));
        const byteArray = new Uint8Array(byteNumbers);
        const blob = new Blob([byteArray], { type: "application/pdf" });

        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `${cust_name}.pdf`;
        link.click();
        URL.revokeObjectURL(link.href);

      } catch (err) {
        console.error("Fetch error:", err);
        alert("Fetch error: " + err.message);
      }
    }
  </script>
</body>
</html>
